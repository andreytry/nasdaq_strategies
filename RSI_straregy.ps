//@version=5
strategy("MACD and RSI Strategy with Custom EMAs", overlay=true)

// MACD calculations
[macdLine, signalLine, _] = ta.macd(close, 12, 26, 9)

// RSI calculation
rsi = ta.rsi(close, 14)

// EMA calculations with custom RGB colors
ema40 = ta.ema(close, 40)
ema20 = ta.ema(close, 20)
ema200 = ta.ema(close, 200)

// Define custom colors with RGB values
colorCyan = color.new(#00FFFF, 0)  // Cyan color for EMA40
colorPink = color.new(#FFC0CB, 0)  // Pink color for EMA20
colorYellow = color.new(#FFFF00, 0) // Yellow color for EMA200

// Plot the EMAs with custom colors
plot(ema40, color=colorCyan, linewidth=2, title="EMA 40")
plot(ema20, color=colorPink, linewidth=2, title="EMA 20")
plot(ema200, color=colorYellow, linewidth=2, title="EMA 200")

// Track RSI oversold and overbought conditions
rsiOversold = rsi < 30
rsiOverbought = rsi > 70

// Track RSI oversold and overbought within the last 10 candles
rsiOversoldRecent = ta.lowest(rsi, 10) < 30
rsiOverboughtRecent = ta.highest(rsi, 10) > 70

// Check if RSI "low" or "high" labels have already been placed in the last 10 candles
var int lastRSILowLabel = na
var int lastRSIHighLabel = na

// MACD crossover conditions
macdCrossOver = ta.crossover(macdLine, signalLine)
macdCrossUnder = ta.crossunder(macdLine, signalLine)

// Plot green lower triangle for MACD Crossover (bullish)
plotshape(series=macdCrossOver, location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small, title="MACD Crossover")

// Plot red upper triangle for MACD Crossunder (bearish)
plotshape(series=macdCrossUnder, location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small, title="MACD Crossunder")

// Detect changes in MACD slope
macdSlopeChangePositive = (macdLine[1] < macdLine[2]) and (macdLine > macdLine[1])  // MACD slope turns positive
macdSlopeChangeNegative = (macdLine[1] > macdLine[2]) and (macdLine < macdLine[1])  // MACD slope turns negative

// Buy condition: MACD slope turns positive and RSI was oversold within the last 10 candles
longCondition = macdSlopeChangePositive and rsiOversoldRecent
if (longCondition)
    strategy.entry("Buy", strategy.long)
    alert("MACD Slope Change with RSI Oversold - Long Entry", alert.freq_once_per_bar)

// Sell condition: MACD slope turns negative and RSI was overbought within the last 10 candles
shortCondition = macdSlopeChangeNegative and rsiOverboughtRecent
if (shortCondition)
    strategy.entry("Sell", strategy.short)
    alert("MACD Slope Change with RSI Overbought - Short Entry", alert.freq_once_per_bar)

// Generate alert and shortened label "RSI" when RSI is oversold, 50 points below the price, but check for recent label
if (rsiOversold and (na(lastRSILowLabel) or (bar_index - lastRSILowLabel > 10)))
    label.new(bar_index, low - 50, text="RSI", color=color.blue, textcolor=color.white, size=size.normal)  // Positioned 50 points below
    alert("RSI Oversold - RSI low", alert.freq_once_per_bar)
    lastRSILowLabel := bar_index

// Generate alert and shortened label "RSI" when RSI is overbought, 50 points above the price, but check for recent label
if (rsiOverbought and (na(lastRSIHighLabel) or (bar_index - lastRSIHighLabel > 10)))
    label.new(bar_index, high + 50, text="RSI", color=color.orange, textcolor=color.white, size=size.normal)  // Positioned 50 points above
    alert("RSI Overbought - RSI high", alert.freq_once_per_bar)
    lastRSIHighLabel := bar_index
