//@version=5
strategy("MACD and RSI Strategy", overlay=true)

// MACD calculations
[macdLine, signalLine, _] = ta.macd(close, 12, 26, 9)

// RSI calculation
rsi = ta.rsi(close, 14)

// Track RSI oversold and overbought conditions
rsiOversold = rsi < 30
rsiOverbought = rsi > 70

// Track RSI oversold and overbought within the last 10 candles
rsiOversoldRecent = ta.lowest(rsi, 10) < 30
rsiOverboughtRecent = ta.highest(rsi, 10) > 70

// Check if RSI "low" or "high" labels have already been placed in the last 10 candles
var int lastRSILowLabel = na
var int lastRSIHighLabel = na

// MACD crossover conditions
macdCrossOver = ta.crossover(macdLine, signalLine)
macdCrossUnder = ta.crossunder(macdLine, signalLine)

// Generate alert and add shortened label "M" for MACD Crossover (bullish)
if (macdCrossOver)
    label.new(bar_index, high, text="M", color=color.green, textcolor=color.white, size=size.normal)
    alert("MACD Crossover - Bullish Signal", alert.freq_once_per_bar)

// Generate alert and add shortened label "M" for MACD Crossunder (bearish)
if (macdCrossUnder)
    label.new(bar_index, low, text="M", color=color.red, textcolor=color.white, size=size.normal)
    alert("MACD Crossunder - Bearish Signal", alert.freq_once_per_bar)

// Buy condition: MACD crossover and RSI was oversold within last 10 candles
longCondition = macdCrossOver and rsiOversoldRecent
if (longCondition)
    strategy.entry("Buy", strategy.long)
    alert("MACD Crossover with RSI Oversold - Long Entry", alert.freq_once_per_bar)

// Sell condition: MACD crossunder and RSI was overbought within last 10 candles
shortCondition = macdCrossUnder and rsiOverboughtRecent
if (shortCondition)
    strategy.entry("Sell", strategy.short)
    alert("MACD Crossunder with RSI Overbought - Short Entry", alert.freq_once_per_bar)

// Generate alert and shortened label "RSI" when RSI is oversold, but check for recent label
if (rsiOversold and (na(lastRSILowLabel) or (bar_index - lastRSILowLabel > 10)))
    label.new(bar_index, low, text="RSI", color=color.blue, textcolor=color.white, size=size.normal)
    alert("RSI Oversold - RSI low", alert.freq_once_per_bar)
    lastRSILowLabel := bar_index

// Generate alert and shortened label "RSI" when RSI is overbought, but check for recent label
if (rsiOverbought and (na(lastRSIHighLabel) or (bar_index - lastRSIHighLabel > 10)))
    label.new(bar_index, high, text="RSI", color=color.orange, textcolor=color.white, size=size.normal)
    alert("RSI Overbought - RSI high", alert.freq_once_per_bar)
    lastRSIHighLabel := bar_index
