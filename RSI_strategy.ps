//@version=5
strategy("Smoothed RSI Strategy with Trend Check", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// === INPUT PARAMETERS ===
rsiLength = input.int(14, title="RSI Length")
smoothLength = input.int(5, title="Smoothing Length")
overboughtLevel = input.int(70, title="Overbought Level")
oversoldLevel = input.int(30, title="Oversold Level")
trendThreshold = input.float(1.5, title="Trend Threshold", step=0.1)
reversalThreshold = input.float(10, title="Reversal Threshold (%)")

// === HELPER FUNCTIONS ===

// Calculate Smoothed RSI
rsi = ta.rsi(close, rsiLength)
smoothedRsi = ta.sma(rsi, smoothLength)

// Detect local min and max for RSI
isLocalMin = ta.lowest(smoothedRsi, 3) == smoothedRsi
isLocalMax = ta.highest(smoothedRsi, 3) == smoothedRsi

// Calculate Trend Strength (Using ATR as a proxy for trend volatility)
atr = ta.atr(14)
trendStrength = atr / ta.sma(close, 14) * 100

// Conditions to enter LONG
enterLong = isLocalMin and (smoothedRsi < oversoldLevel) and (trendStrength < trendThreshold)

// Conditions to enter SHORT
enterShort = isLocalMax and (trendStrength < trendThreshold)

// Conditions to exit LONG
localMaxPrice = ta.highest(smoothedRsi, 3) == smoothedRsi ? smoothedRsi : na
rsiMaxToExitLong = na(localMaxPrice[1]) ? na : localMaxPrice[1] * (1 - reversalThreshold / 100)
exitLong = (smoothedRsi > overboughtLevel) or (isLocalMax and (smoothedRsi < rsiMaxToExitLong))

// Conditions to exit SHORT
localMinPrice = ta.lowest(smoothedRsi, 3) == smoothedRsi ? smoothedRsi : na
rsiMinToExitShort = na(localMinPrice[1]) ? na : localMinPrice[1] * (1 + reversalThreshold / 100)
exitShort = (smoothedRsi < oversoldLevel) or (isLocalMin and (smoothedRsi > rsiMinToExitShort))

// === EXECUTE TRADES ===

// Long Trade Management
if (enterLong)
    strategy.entry("Long", strategy.long)
if (exitLong)
    strategy.close("Long")

// Short Trade Management
if (enterShort)
    strategy.entry("Short", strategy.short)
if (exitShort)
    strategy.close("Short")

// === PLOT INDICATORS ===
plot(smoothedRsi, color=color.blue, title="Smoothed RSI")
hline(overboughtLevel, "Overbought", color=color.red)
hline(oversoldLevel, "Oversold", color=color.green)

plotshape(series=isLocalMin, title="Local Min", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
plotshape(series=isLocalMax, title="Local Max", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small)
